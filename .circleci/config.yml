version: 2

references:
  defaults: &defaults
    working_directory: ~/grpc-gen
    machine: true

jobs:
  lint:
    <<: *defaults
    steps:
      - checkout
      - run:
          name: Lint
          command: for file in `find ssigmaapi -name '*.proto'`; do docker run -v $(pwd):/$(pwd) -w $(pwd) znly/protoc -I. --lint_out=. $file; done
      - persist_to_workspace:
          root: .
          paths:
            - .

  build:
    <<: *defaults
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Clean up
          command: rm -rf gen
      - run:
          name: Check dir
          command: ls
      - run:
          name: Generate gRPC for go
          command: for file in `find ssigmaapi -name '*.proto'`; do docker run -v $(pwd):/defs namely/protoc-all -f $file -l go -i ./ ; done
      - persist_to_workspace:
          root: .
          paths:
            - .

  push:
    <<: *defaults
    steps:
      - attach_workspace:
          at: .
      - run:
          name: git config
          command: |
            git config --global user.email "doumintyu1017@gmail.com"
            git config --global user.name "Generator Bot"
      - run:
          name: git clone go
          command: |
            echo "clone go"
            git clone https://${GH_TOKEN}@github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}go.git
            git -C ./ssigmaapigo rm --cached -r .
            rm -r ssigmaapigo/*
            cp -r gen/pb-go/github.com/sansigma/ssigmaapigo/* ssigmaapigo/
            git -C ./ssigmaapigo add .
            git -C ./ssigmaapigo commit -m "gen"
            git -C ./ssigmaapigo push origin master

workflows:
  version: 2
  build_and_push:
    jobs:
    - lint
    - build:
        requires:
          - lint
        filters:
          branches:
            only:
              - master
    - push:
        requires:
          - lint
          - build
        filters:
          branches:
            only:
              - master